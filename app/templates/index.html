<!DOCTYPE html> <!-- Let's the browser know this is HTML5 -->
<html lang="en">
<head>      <!-- Where metadata about the document is defined -->
    <meta charset="UTF-8">
    <title>Pollen Information</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>Select Pollen Type</h1>
        <label for="pollen_name">Choose a pollen:</label>
        <select name="pollen_name" id="pollen_name"> 
            {% for pollen in pollen_names %}
                <option value="{{ pollen }}">{{ pollen }}</option>
            {% endfor %}
        </select>
        <button id="fetchDataBtn" aria-label="Fetch pollen data">Fetch Data</button>
        <button id="joinDataBtn" aria-label="Fetch joined pollen data">Fetch Joined Tables Data</button>
        <button id="fetchAnnotationsBtn">Fetch Annotations</button>
        <button id="displayImagesBtn">Display Images</button> <!-- image display, new button -->
        <button id="downloadZipBtn">Create Zip File</button> 

    <!-- For displaying tabular data -->
    <div id="dataContainer"></div>

    <!-- For displaying images -->
    <div id="imageContainer"></div>

    <!-- JSZip and FileSaver libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> <!-- Helps create the ZIP-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script> <!-- Enables the ability to download the ZIP file-->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Containers
            const dataContainer = document.getElementById('dataContainer');
            const imageContainer = document.getElementById('imageContainer');
            // Drop-down
            const pollenDropdown = document.getElementById('pollen_name');
            // Buttons
            const fetchDataBtn = document.getElementById('fetchDataBtn');
            const fetchJoinDataBtn = document.getElementById('joinDataBtn');
            const createZipBtn = document.getElementById('createZipBtn')
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            const fetchAnnotationsBtn = document.getElementById('fetchAnnotationsBtn');
            const displayImagesBtn = document.getElementById('displayImagesBtn'); // image display, new button
            
            // Hide download zip button
            downloadZipBtn.style.display = 'none';
            
            // Displays download button after there's data in both containers 
            function checkDataAndImageContainer(){
                if (dataContainer.innerHTML.trim() !== '' && imageContainer.innerHTML.trim() !== ''){
                    downloadZipBtn.style.display = 'inline-block'; // Makes the download zip button reappear
                }
            }

            // Table structure for all data being fetched (REUSED)
            function generateTableHTML(data){
                const selectedPollen = pollenDropdown.value.charAt(0).toUpperCase() + 
                    pollenDropdown.value.slice(1); // Capitalizes the first letter of pollen name

                return `<h1>Query Results For ${selectedPollen}</h1><table><thead><tr>` + 
                        Object.keys(data[0]).map(key => `<th>${key}</th>`).join('') + 
                        '</tr></thead><tbody>' + data.map(row => '<tr>' + 
                        Object.values(row).map(item => `<td>${item}</td>`).join('') + 
                        '</tr>').join('') + '</tbody></table>';
            }
            
            // Requests for DB data
			async function fetchData(endpoint, selectedPollen) {
				try {
					const response = await fetch(endpoint, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ pollen_name: selectedPollen }),
					});
					// learn more about .ok
					if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
					
                    // If request is successful, response.json() parses the JSON from server and returns JS object
					const data = await response.json(); 
					return data;

				} catch (error) {
					console.error('Fetch error:', error);
					return null;
				}
			}
            
            // Requests for images
            async function fetchImages(endpoint, selectedPollen) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST', // This means that the request should use the POST method (Sends data to server)
                        headers: { 'Content-Type': 'application/json' }, // Informs server that the request contains JSON data
                        body: JSON.stringify({ pollen_name: selectedPollen }) // Send as JSON
                    });

                    if (!response.ok) throw new Error(`Error fetching images: ${response.statusText}`);

                    // Get image paths from response
                    const imagePaths = await response.json();

                    // Ensure the response is an array of strings (paths)
                    if (Array.isArray(imagePaths)) {
                        return imagePaths;
                    } else {
                        throw new Error('Response is not in expected format (array of image paths)');
                    }
                    

                } catch (error) {
                    console.error('Image Fetch error:', error);
                    throw error;
                }
            }

            // Ensures data retrieved is valid and displays data in tabular form
			async function handleFetchData(event, endpoint) {
				event.preventDefault();
				const selectedPollen = pollenDropdown.value;
				const data = await fetchData(endpoint, selectedPollen);
				
				if (data && data.length > 0) {
					dataContainer.innerHTML = generateTableHTML(data);
				} else {
					dataContainer.innerHTML = '<h1>No results found</h1>';
				}
                
                // Check if both containers are populated to display downloadZipBtn button
                checkDataAndImageContainer();
			}

            // Ensures Images retrieved is valid and displays images  
            async function handleFetchImages(event, endpoint) {
                event.preventDefault();
                const selectedPollen = pollenDropdown.value;
                const imagePaths = await fetchImages(endpoint, selectedPollen);
                try {
                    // Create img elements for each image path and append them to the imageContainer
                    if (Array.isArray(imagePaths) && imagePaths.length > 0) {
                        imageContainer.innerHTML = ''; // Clear any existing images
                        // learn more about .foreach
                        imagePaths.forEach(path => {
                            const imgElement = document.createElement('img');
                            imgElement.src = path; // The path returned by the server
                            imgElement.alt = 'Pollen Image';
                            imageContainer.appendChild(imgElement);
                        });
                    } else {
                        imageContainer.innerHTML = "<p>No images found for the selected pollen.</p>";
                    }
                } catch (error) {
                    // In case of error, show a user-friendly message
                    imageContainer.innerHTML = "<p>Failed to load images. Please try again later.</p>";
                }

                // Check if both containers are populated to display downloadZipBtn button
                checkDataAndImageContainer();
                
            }


			// Event listeners using the reusable function above
			fetchDataBtn.addEventListener('click', (event) => handleFetchData(event, '{{ url_for("main.fetch_data") }}'));
			fetchJoinDataBtn.addEventListener('click', (event) => handleFetchData(event, '{{ url_for("main.get_related_data_join") }}'));
			fetchAnnotationsBtn.addEventListener('click', (event) => handleFetchData(event, '{{ url_for("main.get_annotations") }}'));
            displayImagesBtn.addEventListener('click', (event) => handleFetchImages(event, '{{ url_for("main.fetch_images") }}'));

            // Handle Zip file download
            // Have gathered data ready for zip file download
            // use a zip library
            // Scenario: after clicking fetch data buttons, data for that pollen will be displayed on website
            // Then, images of that selected pollen will be displayed
            // Then, a button will appear to grab that data + images, store it and make it downloadable.
            downloadZipBtn.addEventListener('click', async() => {
                // Prevent any default behavior
                event.preventDefault();
                
                // Want to grab both data that gets fetched after clicking button & images
                const pollenData = data; // Contains the fetched data
                
                // Add image to ZIP file

                // Add annotation data


                // Generate the ZIP file and trigger the download
                
            });
        });
    </script>
    <!-- <img src="{{ url_for('static', filename='img/capy.jpg') }}" alt="judgemental capybara"> -->
</body>
</html>
